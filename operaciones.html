
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Operaciones - KingSoft</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #4366e6, #3048b8);
    color: #f0f0f0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2vw;
  }
  h1 {
    font-size: clamp(2rem, 6vw, 2.8rem);
    font-weight: 800;
    margin-bottom: 3vw;
    text-shadow: 1px 1px 6px rgba(0,0,0,0.4);
    user-select: none;
    text-align: center;
  }
  /* Logout icon */
  .logout-container {
    position: fixed;
    top: 2vw;
    right: 2vw;
    z-index: 1000;
  }
  .logout-icon {
    width: clamp(24px, 4vw, 32px);
    height: clamp(24px, 4vw, 32px);
    fill: #f0f0f0;
    cursor: pointer;
    transition: fill 0.3s ease, transform 0.3s ease;
  }
  .logout-icon:hover {
    fill: #ff4d4d;
    transform: scale(1.1);
  }
  /* Menu principal */
  .menu {
    display: flex;
    justify-content: center;
    gap: clamp(10px, 2vw, 18px);
    flex-wrap: wrap;
    margin-bottom: 3vw;
    width: 100%;
    max-width: 1200px;
  }
  .menu button {
    background: #f0f0f0;
    color: #3048b8;
    font-weight: 700;
    font-size: clamp(0.9rem, 2.5vw, 1.1rem);
    border: none;
    border-radius: 12px;
    padding: clamp(10px, 2vw, 14px) clamp(20px, 3vw, 28px);
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(255,255,255,0.6);
    transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    flex: 1;
    min-width: clamp(100px, 20vw, 140px);
    text-align: center;
  }
  .menu button:hover, .menu button.active {
    background: #3048b8;
    color: #f0f0f0;
    box-shadow: 0 6px 25px rgba(67,102,230,0.9);
  }
  /* Submenu Ver/Registrar */
  .sub-menu {
    display: flex;
    justify-content: center;
    gap: clamp(15px, 2vw, 25px);
    margin-bottom: 3vw;
    width: 100%;
    max-width: 720px;
  }
  .sub-menu button {
    padding: clamp(8px, 2vw, 12px) clamp(20px, 3vw, 30px);
    font-size: clamp(0.85rem, 2.5vw, 1rem);
    font-weight: 700;
    background: transparent;
    border: 2.5px solid #f0f0f0;
    color: #f0f0f0;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    flex: 1;
    max-width: 200px;
  }
  .sub-menu button:hover,
  .sub-menu button.active {
    background: #f0f0f0;
    color: #3048b8;
    border-color: #3048b8;
    box-shadow: 0 4px 20px rgba(255,255,255,0.6);
  }
  /* Contenedor principal contenido */
  #content {
    background: #f0f0f0;
    color: #3048b8;
    border-radius: 20px;
    padding: clamp(20px, 3vw, 30px) clamp(20px, 4vw, 40px);
    max-width: 100%;
    width: clamp(300px, 90vw, 720px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    min-height: clamp(300px, 50vh, 460px);
  }
  #content h2 {
    margin-top: 0;
    font-weight: 900;
    color: #4366e6;
    letter-spacing: 0.06em;
    user-select: none;
    font-size: clamp(1.5rem, 4vw, 1.8rem);
  }
  /* Scrollable list container */
  .list-container {
    max-height: clamp(200px, 40vh, 400px);
    overflow-y: auto;
    margin-top: clamp(12px, 2vw, 18px);
    border-radius: 10px;
    border: 1.5px solid #b0c4ff;
    background: #ffffff;
    padding: clamp(5px, 1vw, 10px);
  }
  .list-container::-webkit-scrollbar {
    width: 8px;
  }
  .list-container::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 10px;
  }
  .list-container::-webkit-scrollbar-thumb {
    background: #4366e6;
    border-radius: 10px;
  }
  .list-container::-webkit-scrollbar-thumb:hover {
    background: #3048b8;
  }
  /* Formularios */
  form label {
    display: block;
    font-weight: 700;
    margin-bottom: 8px;
    color: #3048b8;
    font-size: clamp(0.9rem, 2.5vw, 1rem);
  }
  form input, form textarea, form select {
    width: 100%;
    padding: clamp(8px, 2vw, 12px) clamp(10px, 2vw, 15px);
    margin-bottom: clamp(15px, 2vw, 22px);
    border: 2px solid #b0c4ff;
    border-radius: 10px;
    font-size: clamp(0.85rem, 2.5vw, 0.95rem);
    transition: border-color 0.25s ease;
  }
  form input:focus, form textarea:focus, form select:focus {
    border-color: #4366e6;
    outline: none;
    box-shadow: 0 0 8px #4366e6aa;
  }
  form textarea {
    resize: vertical;
    min-height: clamp(60px, 10vh, 70px);
  }
  /* Primary button style */
  .btn-primary {
    background-color: #4366e6;
    color: white;
    font-weight: 800;
    font-size: clamp(0.9rem, 2.5vw, 1.1rem);
    border: none;
    padding: clamp(10px, 2vw, 14px) clamp(20px, 3vw, 32px);
    border-radius: 15px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    box-shadow: 0 5px 15px rgba(67,102,230,0.75);
    user-select: none;
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
    display: block;
  }
  .btn-primary:hover {
    background-color: #3048b8;
  }
  #mic-icon-container {
    text-align: center;
    margin-bottom: clamp(15px, 2vw, 20px);
  }
  #mic-icon, #mic-asesoria, #mic-proyecto, #mic-gasto, #mic-deuda {
    cursor: pointer;
    width: clamp(36px, 5vw, 42px);
    fill: #4366e6;
    transition: fill 0.3s ease;
  }
  #mic-icon:hover, #mic-asesoria:hover, #mic-proyecto:hover, #mic-gasto:hover, #mic-deuda:hover {
    fill: #3048b8;
  }
  /* Tablas */
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: clamp(10px, 2vw, 14px) clamp(12px, 2vw, 18px);
    border: 1.5px solid #b0c4ff;
    color: #3048b8;
    user-select: text;
    font-size: clamp(0.8rem, 2.5vw, 0.9rem);
  }
  th {
    background-color: #4366e6;
    color: white;
    font-weight: 800;
    letter-spacing: 0.05em;
  }
  /* Mensajes */
  #mensaje, #mensaje-proyecto, #mensaje-gasto, #mensaje-deuda {
    margin-top: clamp(15px, 2vw, 22px);
    font-weight: 700;
    font-size: clamp(0.85rem, 2.5vw, 1rem);
    color: #2c3e50;
  }
  /* Estado del micrófono */
  .mic-status {
    margin-top: 10px;
    font-weight: 600;
    font-size: clamp(0.8rem, 2.5vw, 0.9rem);
    color: #4366e6;
  }
  /* Estilo para el textarea de análisis financiero */
  #analisis-textarea, #resultados-textarea {
    background-color: #e9ecef;
    color: #3048b8;
    font-weight: 500;
    min-height: clamp(100px, 20vh, 150px);
    resize: none;
    cursor: default;
    width: 100%;
  }
  #analisis-textarea[error], #resultados-textarea[error] {
    border-color: #dc3545;
    color: #dc3545;
  }
  /* Date filter container */
  .date-filters {
    display: flex;
    gap: clamp(10px, 2vw, 20px);
    margin-bottom: clamp(15px, 2vw, 20px);
    flex-wrap: wrap;
  }
  .date-filters div {
    flex: 1;
    min-width: clamp(120px, 40vw, 150px);
  }
  /* Responsive adjustments */
  @media (max-width: 1024px) {
    .menu {
      gap: clamp(8px, 1.5vw, 12px);
    }
    .menu button {
      min-width: clamp(90px, 22vw, 120px);
      padding: clamp(8px, 1.5vw, 12px) clamp(15px, 2.5vw, 20px);
    }
    .sub-menu {
      gap: clamp(10px, 1.5vw, 15px);
    }
    .sub-menu button {
      padding: clamp(8px, 1.5vw, 10px) clamp(15px, 2.5vw, 20px);
    }
    #content {
      padding: clamp(15px, 2.5vw, 20px) clamp(15px, 3vw, 25px);
    }
    .list-container {
      max-height: clamp(180px, 35vh, 350px);
    }
  }
  @media (max-width: 768px) {
    body {
      padding: clamp(10px, 3vw, 15px);
    }
    h1 {
      font-size: clamp(1.8rem, 5vw, 2.2rem);
    }
    .menu {
      flex-direction: column;
      align-items: center;
    }
    .menu button {
      width: 100%;
      max-width: 300px;
    }
    .sub-menu {
      flex-direction: column;
      align-items: center;
    }
    .sub-menu button {
      width: 100%;
      max-width: 300px;
    }
    .date-filters {
      flex-direction: column;
      gap: 10px;
    }
    .logout-icon {
      width: clamp(20px, 3.5vw, 24px);
      height: clamp(20px, 3.5vw, 24px);
    }
    .list-container {
      max-height: clamp(150px, 30vh, 300px);
    }
  }
  @media (max-width: 480px) {
    h1 {
      font-size: clamp(1.5rem, 4.5vw, 1.8rem);
    }
    #content {
      padding: clamp(10px, 2vw, 15px);
      min-height: clamp(250px, 45vh, 300px);
    }
    form input, form textarea, form select {
      font-size: clamp(0.8rem, 2.2vw, 0.9rem);
    }
    .btn-primary {
      padding: clamp(8px, 1.5vw, 10px) clamp(15px, 2.5vw, 20px);
    }
    .mic-status {
      font-size: clamp(0.75rem, 2vw, 0.85rem);
    }
    .list-container {
      max-height: clamp(120px, 25vh, 250px);
    }
  }
</style>
</head>
<body>

<h1>Panel de Operaciones</h1>

<div class="logout-container" role="button" aria-label="Cerrar sesión">
  <a href="inicio.html" title="Cerrar sesión">
    <svg class="logout-icon" viewBox="0 0 24 24" stroke="#f0f0f0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5-5-5m5 5H11"/>
    </svg>
  </a>
</div>

<div class="menu" role="menu" aria-label="Menú de operaciones">
  <button data-op="proyectos" aria-haspopup="true" aria-controls="submenu">Proyectos</button>
  <button data-op="ventas" aria-haspopup="true" aria-controls="submenu">Ventas</button>
  <button data-op="gastos" aria-haspopup="true" aria-controls="submenu">Gastos</button>
  <button data-op="deudas" aria-haspopup="true" aria-controls="submenu">Deudas</button>
  <button data-op="asesoria" aria-haspopup="false">Asesoría Financiera</button>
</div>

<div class="sub-menu" role="menubar" aria-label="Opciones de ver o registrar" style="display:none;">
  <button id="ver-btn" aria-pressed="true">Ver</button>
  <button id="registrar-btn" aria-pressed="false">Registrar</button>
</div>

<div id="content" role="main" tabindex="0">
  <p>Seleccione una operación para continuar.</p>
</div>

<script>
  const menuButtons = document.querySelectorAll('.menu button');
  const subMenu = document.querySelector('.sub-menu');
  const verBtn = document.getElementById('ver-btn');
  const registrarBtn = document.getElementById('registrar-btn');
  const content = document.getElementById('content');

  let currentOperation = null;

  menuButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      currentOperation = btn.dataset.op;

      if(currentOperation === 'asesoria'){
        subMenu.style.display = 'none';
        loadView(null, 'asesoria');
        setAria(false);
      } else {
        subMenu.style.display = 'flex';
        verBtn.classList.add('active');
        registrarBtn.classList.remove('active');
        verBtn.setAttribute('aria-pressed', 'true');
        registrarBtn.setAttribute('aria-pressed', 'false');
        loadView('ver', currentOperation);
        setAria(true);
      }

      menuButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  verBtn.addEventListener('click', () => {
    if(!currentOperation) return;
    verBtn.classList.add('active');
    registrarBtn.classList.remove('active');
    verBtn.setAttribute('aria-pressed', 'true');
    registrarBtn.setAttribute('aria-pressed', 'false');
    loadView('ver', currentOperation);
  });

  registrarBtn.addEventListener('click', () => {
    if(!currentOperation) return;
    verBtn.classList.remove('active');
    registrarBtn.classList.add('active');
    verBtn.setAttribute('aria-pressed', 'false');
    registrarBtn.setAttribute('aria-pressed', 'true');
    loadView('registrar', currentOperation);
  });

  function setAria(enabled){
    verBtn.disabled = !enabled;
    registrarBtn.disabled = !enabled;
  }

  function loadView(view, operation) {
    if(!operation){
      content.innerHTML = '<p>Seleccione una operación para continuar.</p>';
      subMenu.style.display = 'none';
      return;
    }

    switch(operation){
      case 'ventas':
        if(view === 'ver'){
          content.innerHTML = `
            <h2>Listado de Ventas</h2>
            <div class="list-container" aria-live="polite">
              <div id="ventas-listado">Cargando...</div>
            </div>
          `;
          fetch('listar_ventas.php')
          .then(res => {
            console.log('Respuesta de API (Listar Ventas):', {
              status: res.status,
              statusText: res.statusText
            });
            return res.text();
          })
          .then(html => document.getElementById('ventas-listado').innerHTML = html)
          .catch(error => {
            console.error('Error en API (Listar Ventas):', error);
            document.getElementById('ventas-listado').innerHTML = '<p>Error al cargar ventas.</p>';
          });
        } else {
          loadRegistrarVentas();
        }
        break;

      case 'proyectos':
        if(view === 'ver'){
          content.innerHTML = `
            <h2>Listado de Proyectos</h2>
            <div class="list-container" aria-live="polite">
              <p>Funcionalidad para listar proyectos aún no implementada.</p>
            </div>
          `;
        } else {
          loadRegistrarProyectos();
        }
        break;

      case 'gastos':
        if(view === 'ver'){
          content.innerHTML = `
            <h2>Listado de Gastos</h2>
            <div class="list-container" aria-live="polite">
              <div id="gastos-listado">Cargando...</div>
            </div>
          `;
          fetch('listar_gastos.php')
          .then(res => {
            console.log('Respuesta de API (Listar Gastos):', {
              status: res.status,
              statusText: res.statusText
            });
            return res.text();
          })
          .then(html => document.getElementById('gastos-listado').innerHTML = html)
          .catch(error => {
            console.error('Error en API (Listar Gastos):', error);
            document.getElementById('gastos-listado').innerHTML = '<p>Error al cargar gastos.</p>';
          });
        } else {
          loadRegistrarGastos();
        }
        break;

      case 'deudas':
        if(view === 'ver'){
          content.innerHTML = `
            <h2>Listado de Deudas</h2>
            <div class="list-container" aria-live="polite">
              <div id="deudas-listado">Cargando...</div>
            </div>
          `;
          fetch('listar_deudas.php')
          .then(res => {
            console.log('Respuesta de API (Listar Deudas):', {
              status: res.status,
              statusText: res.statusText
            });
            return res.text();
          })
          .then(html => document.getElementById('deudas-listado').innerHTML = html)
          .catch(error => {
            console.error('Error en API (Listar Deudas):', error);
            document.getElementById('deudas-listado').innerHTML = '<p>Error al cargar deudas.</p>';
          });
        } else {
          loadRegistrarDeudas();
        }
        break;

      case 'asesoria':
        content.innerHTML = `
          <h2>Asesoría Financiera</h2>
          <p>Analiza la información registrada y obtén recomendaciones personalizadas.</p>
          <div id="mic-icon-container" aria-label="Ingresar análisis financiero por voz" role="button" tabindex="0">
            <svg id="mic-asesoria" viewBox="0 0 24 24" fill="#4366e6" stroke="#4366e6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM12 19v3m-4 0h8"/>
            </svg>
            <div id="mic-status" class="mic-status">Presione el micrófono para analizar por voz</div>
          </div>
          <div class="date-filters" role="group" aria-label="Filtros de fecha">
            <div>
              <label for="fecha-desde">Desde</label>
              <input type="date" id="fecha-desde" name="fecha-desde" required aria-describedby="fecha-desde-help">
              <span id="fecha-desde-help" class="sr-only"></span>
            </div>
            <div>
              <label for="fecha-hasta">Hasta</label>
              <input type="date" id="fecha-hasta" name="fecha-hasta" required aria-describedby="fecha-hasta-help">
              <span id="fecha-hasta-help" class="sr-only"></span>
            </div>
          </div>
          <button id="revisar-btn" class="btn-primary" aria-label="Revisar análisis financiero">
            Revisar
          </button>
          <div id="asesoria-result">
            <label for="resultados-textarea">Análisis y Recomendaciones</label>
            <textarea id="resultados-textarea" readonly placeholder="El análisis y las recomendaciones aparecerán aquí..." aria-live="polite"></textarea>
          </div>
        `;
        
        const micAsesoria = document.getElementById('mic-asesoria');
        const micStatus = document.getElementById('mic-status');
        const fechaDesdeInput = document.getElementById('fecha-desde');
        const fechaHastaInput = document.getElementById('fecha-hasta');
        const resultadosTextarea = document.getElementById('resultados-textarea');

        // Set default dates
        const today = new Date();
        fechaHastaInput.value = today.toISOString().split('T')[0];
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(today.getMonth() - 1);
        fechaDesdeInput.value = oneMonthAgo.toISOString().split('T')[0];

        // Validate date range
        function validateDates() {
          if (new Date(fechaDesdeInput.value) > new Date(fechaHastaInput.value)) {
            resultadosTextarea.value = "Error: La fecha de inicio no puede ser posterior a la fecha de fin";
            resultadosTextarea.setAttribute('error', '');
            micStatus.textContent = "Error en las fechas seleccionadas";
            micStatus.style.color = "#dc3545";
            console.warn('Error en validación de fechas:', {
              fechaDesde: fechaDesdeInput.value,
              fechaHasta: fechaHastaInput.value
            });
            return false;
          }
          return true;
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          const recognition = new SpeechRecognition();
          recognition.lang = 'es-PE';
          recognition.interimResults = false;
          recognition.maxAlternatives = 1;

          micAsesoria.addEventListener('click', () => {
            try {
              micStatus.textContent = "Escuchando... Hable ahora";
              micStatus.style.color = "#4366e6";
              recognition.start();
            } catch (error) {
              console.error('Error al iniciar reconocimiento de voz (Asesoría):', error);
              micStatus.textContent = "Error al iniciar el micrófono: " + error.message;
              micStatus.style.color = "#dc3545";
              resultadosTextarea.value = "Error al iniciar el micrófono: " + error.message;
              resultadosTextarea.setAttribute('error', '');
              resetMicStatus(micStatus);
            }
          });

          recognition.onresult = async (event) => {
            const speechResult = event.results[0][0].transcript;
            micStatus.textContent = "Transcripción recibida: " + speechResult;
            micStatus.style.color = "#28a745";

            if (!validateDates()) return;

            try {
              micStatus.textContent = "Procesando análisis financiero...";
              const requestData = {
                texto: speechResult,
                fecha_desde: fechaDesdeInput.value,
                fecha_hasta: fechaHastaInput.value,
                fecha: new Date().toISOString()
              };
              console.log('Enviando datos a API (Asesoría por voz):', requestData);

              const response = await fetch('https://www.kingsoft.pe:5678/webhook/finansa', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
              });

              console.log('Respuesta de API (Asesoría por voz):', {
                status: response.status,
                statusText: response.statusText
              });

              if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
              }

              const data = await response.json();
              console.log('Datos recibidos de API (Asesoría por voz):', data);

              if (data.respuesta || data.recomendaciones) {
                let output = '';
                if (data.respuesta) output += `Análisis Financiero:\n${data.respuesta.trim()}\n\n`;
                if (data.resumen) output += `Resumen:\n${data.resumen.trim()}\n\n`;
                if (data.balance !== undefined) output += `Balance: ${data.balance}\n`;
                if (data.estado_financiero) output += `Estado Financiero: ${data.estado_financiero}\n\n`;
                if (data.recomendaciones) output += `Recomendaciones:\n${data.recomendaciones.trim()}`;
                resultadosTextarea.value = output.trim();
                resultadosTextarea.removeAttribute('error');
                micStatus.textContent = "Análisis financiero procesado correctamente";
                micStatus.style.color = "#28a745";
                announceSuccess("Análisis y recomendaciones generados");
              } else {
                const errorMessage = data.message || 'No se recibieron datos válidos del análisis financiero';
                console.warn('Error reportado por API (Asesoría por voz):', errorMessage);
                micStatus.textContent = "Error al procesar análisis financiero: " + errorMessage;
                micStatus.style.color = "#dc3545";
                resultadosTextarea.value = `Error: ${errorMessage}`;
                resultadosTextarea.setAttribute('error', '');
              }
            } catch (error) {
              console.error('Error en API (Asesoría por voz):', error);
              const errorMessage = error.message || 'No se pudo conectar con el servidor';
              micStatus.textContent = "Error de conexión con el servicio: " + errorMessage;
              micStatus.style.color = "#dc3545";
              resultadosTextarea.value = `Error en conexión: ${errorMessage}`;
              resultadosTextarea.setAttribute('error', '');
              resetMicStatus(micStatus);
            }
          };

          recognition.onerror = (event) => {
            let errorMessage = "Error en reconocimiento de voz: ";
            switch(event.error) {
              case 'no-speech':
                errorMessage += "No se detectó voz";
                break;
              case 'audio-capture':
                errorMessage += "No se pudo capturar audio";
                break;
              case 'not-allowed':
                errorMessage += "Permiso denegado para usar el micrófono";
                break;
              default:
                errorMessage += event.error;
            }
            console.error('Error en reconocimiento de voz (Asesoría):', event.error);
            micStatus.textContent = errorMessage;
            micStatus.style.color = "#dc3545";
            resultadosTextarea.value = errorMessage;
            resultadosTextarea.setAttribute('error', '');
            resetMicStatus(micStatus);
          };

          recognition.onsoundend = () => {
            if (micStatus.textContent === "Escuchando... Hable ahora") {
              micStatus.textContent = "Tiempo de escucha terminado";
              micStatus.style.color = "#dc3545";
              resultadosTextarea.value = "Tiempo de escucha terminado sin detectar voz";
              resultadosTextarea.setAttribute('error', '');
              resetMicStatus(micStatus);
            }
          };
        } else {
          console.warn('Reconocimiento de voz no disponible en el navegador (Asesoría)');
          micAsesoria.style.display = 'none';
          micStatus.textContent = "El reconocimiento de voz no está disponible en este navegador";
          micStatus.style.color = "#dc3545";
          resultadosTextarea.value = "El reconocimiento de voz no está disponible en este navegador";
          resultadosTextarea.setAttribute('error', '');
        }

        document.getElementById('revisar-btn').addEventListener('click', async () => {
          if (!validateDates()) return;

          try {
            resultadosTextarea.value = "Analizando información...";
            resultadosTextarea.removeAttribute('error');

            const requestData = {
              texto: '',
              fecha_desde: fechaDesdeInput.value,
              fecha_hasta: fechaHastaInput.value,
              fecha: new Date().toISOString()
            };
            console.log('Enviando datos a API (Asesoría por botón):', requestData);

            const response = await fetch('https://www.kingsoft.pe:5678/webhook/finansa', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestData)
            });

            console.log('Respuesta de API (Asesoría por botón):', {
              status: response.status,
              statusText: response.statusText
            });

            if (!response.ok) {
              throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            console.log('Datos recibidos de API (Asesoría por botón):', data);

            if (data.respuesta || data.recomendaciones) {
              let output = '';
              if (data.respuesta) output += `Análisis Financiero:\n${data.respuesta.trim()}\n\n`;
              if (data.resumen) output += `Resumen:\n${data.resumen.trim()}\n\n`;
              if (data.balance !== undefined) output += `Balance: ${data.balance}\n`;
              if (data.estado_financiero) output += `Estado Financiero: ${data.estado_financiero}\n\n`;
              if (data.recomendaciones) output += `Recomendaciones:\n${data.recomendaciones.trim()}`;
              resultadosTextarea.value = output.trim();
              resultadosTextarea.removeAttribute('error');
              micStatus.textContent = "Análisis financiero procesado correctamente";
              micStatus.style.color = "#28a745";
              announceSuccess("Análisis y recomendaciones generados con éxito");
            } else {
              const errorMessage = data.message || 'No se recibieron datos válidos del análisis financiero';
              console.warn('Error reportado por API (Asesoría por botón):', errorMessage);
              resultadosTextarea.value = `Error: ${errorMessage}`;
              resultadosTextarea.setAttribute('error', '');
              micStatus.textContent = "Error al procesar análisis financiero: " + errorMessage;
              micStatus.style.color = "#dc3545";
            }
          } catch (error) {
            console.error('Error en API (Asesoría por botón):', error);
            const errorMessage = error.message || 'No se pudo conectar con el servidor';
            resultadosTextarea.value = `Error en conexión: ${errorMessage}`;
            resultadosTextarea.setAttribute('error', '');
            micStatus.textContent = "Error de conexión con el servicio: " + errorMessage;
            micStatus.style.color = "#dc3545";
            resetMicStatus(micStatus);
          }
        });
        break;

      default:
        content.innerHTML = '<p>Funcionalidad no disponible.</p>';
    }
  }

  function resetMicStatus(micStatus) {
    setTimeout(() => {
      micStatus.textContent = "Presione el micrófono para registrar por voz";
      micStatus.style.color = "#4366e6";
    }, 5000);
  }

  function announceSuccess(message) {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(message);
      utterance.lang = 'es-PE';
      utterance.volume = 1;
      utterance.rate = 1;
      utterance.pitch = 1;
      window.speechSynthesis.speak(utterance);
    }
  }

  function loadRegistrarVentas() {
    content.innerHTML = `
      <h2>Registrar Venta</h2>
      <div id="mic-icon-container" aria-label="Ingresar por voz" role="button" tabindex="0">
        <svg id="mic-icon" viewBox="0 0 24 24" fill="#4366e6" stroke="#4366e6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM12 19v3m-4 0h8"/>
        </svg>
        <div id="mic-status" class="mic-status">Presione el micrófono para registrar venta por voz</div>
      </div>
      <form id="venta-form" aria-label="Formulario para registrar venta">
        <label for="nombre_producto">Nombre de producto</label>
        <input type="text" id="nombre_producto" name="nombre_producto" required />

        <label for="descripcion">Descripción</label>
        <textarea id="descripcion" name="descripcion" rows="3"></textarea>

        <label for="precio_unitario">Precio Unitario</label>
        <input type="number" id="precio_unitario" name="precio_unitario" step="0.01" required />

        <label for="cantidad">Cantidad</label>
        <input type="number" id="cantidad" name="cantidad" required />

        <label for="total">Total</label>
        <input type="number" id="total" name="total" step="0.01" readonly />

        <button type="submit" class="btn-primary">Guardar Venta</button>
      </form>
      <div id="mensaje"></div>
    `;
    setupVentaForm();
  }

  function setupVentaForm(){
    const precioInput = document.getElementById('precio_unitario');
    const cantidadInput = document.getElementById('cantidad');
    const totalInput = document.getElementById('total');
    const micIcon = document.getElementById('mic-icon');
    const micStatus = document.getElementById('mic-status');
    const nombreInput = document.getElementById('nombre_producto');
    const descripcionInput = document.getElementById('descripcion');
    const ventaForm = document.getElementById('venta-form');
    const mensajeDiv = document.getElementById('mensaje');

    function calcularTotal() {
      const precio = parseFloat(precioInput.value) || 0;
      const cantidad = parseInt(cantidadInput.value) || 0;
      totalInput.value = (precio * cantidad).toFixed(2);
    }

    precioInput.addEventListener('input', calcularTotal);
    cantidadInput.addEventListener('input', calcularTotal);

    async function registrarVentaPorVoz(transcripcion) {
      try {
        micStatus.textContent = "Procesando venta...";
        const requestData = {
          texto: transcripcion,
          fecha: new Date().toISOString()
        };
        console.log('Enviando datos a API (Venta por voz):', requestData);

        const response = await fetch('https://www.kingsoft.pe:5678/webhook/venta', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        });

        console.log('Respuesta de API (Venta por voz):', {
          status: response.status,
          statusText: response.statusText
        });

        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Datos recibidos de API (Venta por voz):', data);

        if (data.success) {
          if (data.producto) nombreInput.value = data.producto;
          if (data.descripcion) descripcionInput.value = data.descripcion;
          if (data.precio) precioInput.value = data.precio;
          if (data.cantidad) cantidadInput.value = data.cantidad;

          calcularTotal();

          micStatus.textContent = "Venta registrada por voz correctamente";
          micStatus.style.color = "#28a745";
          mensajeDiv.innerHTML = '<p style="color:green;">Venta registrada por voz correctamente. Revise los datos y haga clic en "Guardar Venta" para confirmar.</p>';
          announceSuccess("Venta registrada con éxito");
        } else {
          micStatus.textContent = "Error al procesar venta por voz: " + (data.message || 'Error desconocido');
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      } catch (error) {
        console.error('Error en API (Venta por voz):', error);
        micStatus.textContent = "Error de conexión con el servicio de voz: " + error.message;
        micStatus.style.color = "#dc3545";
        resetMicStatus(micStatus);
      }
    }

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-PE';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      micIcon.addEventListener('click', () => {
        try {
          micStatus.textContent = "Escuchando... Hable ahora";
          micStatus.style.color = "#4366e6";
          recognition.start();
        } catch (error) {
          console.error('Error al iniciar reconocimiento de voz (Venta):', error);
          micStatus.textContent = "Error al iniciar el micrófono: " + error.message;
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      });

      recognition.onresult = (event) => {
        const speechResult = event.results[0][0].transcript;
        micStatus.textContent = "Transcripción recibida: " + speechResult;
        micStatus.style.color = "#28a745";
        registrarVentaPorVoz(speechResult);
      };

      recognition.onerror = (event) => {
        let errorMessage = "Error en reconocimiento de voz: ";
        switch(event.error) {
          case 'no-speech':
            errorMessage += "No se detectó voz";
            break;
          case 'audio-capture':
            errorMessage += "No se pudo capturar audio";
            break;
          case 'not-allowed':
            errorMessage += "Permiso denegado para usar el micrófono";
            break;
          default:
            errorMessage += event.error;
        }
        console.error('Error en reconocimiento de voz (Venta):', event.error);
        micStatus.textContent = errorMessage;
        micStatus.style.color = "#dc3545";
        resetMicStatus(micStatus);
      };

      recognition.onsoundend = () => {
        if (micStatus.textContent === "Escuchando... Hable ahora") {
          micStatus.textContent = "Tiempo de escucha terminado";
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      };
    } else {
      micIcon.style.display = 'none';
      micStatus.textContent = "El reconocimiento de voz no está disponible en este navegador";
      micStatus.style.color = "#dc3545";
    }

    ventaForm.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(ventaForm);
      const formDataObject = Object.fromEntries(formData);
      console.log('Enviando datos a API (Formulario Venta):', formDataObject);

      fetch('guardar_venta.php', {
        method: 'POST',
        body: formData
      })
      .then(res => {
        console.log('Respuesta de API (Formulario Venta):', {
          status: res.status,
          statusText: res.statusText
        });
        if (!res.ok) {
          throw new Error(`Error HTTP: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        console.log('Datos recibidos de API (Formulario Venta):', data);
        if(data.success){
          mensajeDiv.innerHTML = '<p style="color:green;">Venta registrada con éxito.</p>';
          ventaForm.reset();
          totalInput.value = '';
          micStatus.textContent = "Presione el micrófono para registrar venta por voz";
          micStatus.style.color = "#4366e6";
          announceSuccess("Venta guardada con éxito");
        } else {
          mensajeDiv.innerHTML = '<p style="color:red;">Error al registrar venta: ' + data.message + '</p>';
        }
      })
      .catch(error => {
        console.error('Error en API (Formulario Venta):', error);
        mensajeDiv.innerHTML = '<p style="color:red;">Error en conexión con el servidor: ' + error.message + '</p>';
      });
    });
  }

  function loadRegistrarProyectos() {
    content.innerHTML = `
      <h2>Registrar Proyecto</h2>
      <div id="mic-icon-container" aria-label="Ingresar por voz" role="button" tabindex="0">
        <svg id="mic-proyecto" viewBox="0 0 24 24" fill="#4366e6" stroke="#4366e6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM12 19v3m-4 0h8"/>
        </svg>
        <div id="mic-status" class="mic-status">Presione el micrófono para registrar proyecto por voz</div>
      </div>
      <form id="proyecto-form" aria-label="Formulario para registrar proyecto">
        <label for="nombre_proyecto">Nombre de proyecto</label>
        <input type="text" id="nombre_proyecto" name="nombre_proyecto" required />

        <label for="descripcion">Descripción</label>
        <textarea id="descripcion" name="descripcion" rows="3"></textarea>

        <label for="fecha_inicio">Fecha de inicio</label>
        <input type="date" id="fecha_inicio" name="fecha_inicio" required />

        <label for="fecha_fin">Fecha de fin</label>
        <input type="date" id="fecha_fin" name="fecha_fin" required />

        <label for="estado">Estado</label>
        <select id="estado" name="estado" required>
          <option value="Pendiente">Pendiente</option>
          <option value="En curso">En curso</option>
          <option value="Finalizado">Finalizado</option>
          <option value="Cancelado">Cancelado</option>
        </select>

        <button type="submit" class="btn-primary">Guardar Proyecto</button>
      </form>
      <div id="mensaje-proyecto"></div>
    `;

    const proyectoForm = document.getElementById('proyecto-form');
    const mensajeProyectoDiv = document.getElementById('mensaje-proyecto');
    const micProyecto = document.getElementById('mic-proyecto');
    const micStatus = document.getElementById('mic-status');
    const nombreProyectoInput = document.getElementById('nombre_proyecto');
    const descripcionInput = document.getElementById('descripcion');
    const fechaInicioInput = document.getElementById('fecha_inicio');
    const fechaFinInput = document.getElementById('fecha_fin');
    const estadoInput = document.getElementById('estado');

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-PE';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      micProyecto.addEventListener('click', () => {
        try {
          micStatus.textContent = "Escuchando... Hable ahora";
          micStatus.style.color = "#4366e6";
          recognition.start();
        } catch (error) {
          console.error('Error al iniciar reconocimiento de voz (Proyecto):', error);
          micStatus.textContent = "Error al iniciar el micrófono: " + error.message;
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      });

      recognition.onresult = async (event) => {
        const speechResult = event.results[0][0].transcript;
        micStatus.textContent = "Transcripción recibida: " + speechResult;
        micStatus.style.color = "#28a745";

        try {
          micStatus.textContent = "Procesando proyecto...";
          const requestData = {
            texto: speechResult,
            fecha: new Date().toISOString()
          };
          console.log('Enviando datos a API (Proyecto por voz):', requestData);

          const response = await fetch('https://www.kingsoft.pe:5678/webhook/proyecto', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
          });

          console.log('Respuesta de API (Proyecto por voz):', {
            status: response.status,
            statusText: response.statusText
          });

          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          console.log('Datos recibidos de API (Proyecto por voz):', data);

          if (data.success) {
            if (data.nombre) nombreProyectoInput.value = data.nombre;
            if (data.descripcion) descripcionInput.value = data.descripcion;
            if (data.fecha_inicio) fechaInicioInput.value = data.fecha_inicio.split('T')[0];
            if (data.fecha_fin) fechaFinInput.value = data.fecha_fin.split('T')[0];
            if (data.estado) estadoInput.value = data.estado;

            micStatus.textContent = "Proyecto registrado por voz correctamente";
            micStatus.style.color = "#28a745";
            mensajeProyectoDiv.innerHTML = '<p style="color:green;">Proyecto registrado con éxito. Revise los datos y haga clic en "Guardar" para confirmar.</p>';
            announceSuccess("Proyecto registrado con éxito");
          } else {
            micStatus.textContent = "Error al procesar proyecto por voz: " + (data.message || 'Error desconocido');
            micStatus.style.color = "#dc3545";
            resetMicStatus(micStatus);
          }
        } catch (error) {
          console.error('Error en API (Proyecto por voz):', error);
          micStatus.textContent = "Error de conexión con el servicio de voz: " + error.message;
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      };

      recognition.onerror = (event) => {
        let errorMessage = "Error en reconocimiento de voz: ";
        switch(event.error) {
          case 'no-speech':
            errorMessage += "No se detectó voz";
            break;
          case 'audio-capture':
            errorMessage += "No se pudo capturar audio";
            break;
          case 'not-allowed':
            errorMessage += "Permiso denegado para usar el micrófono";
            break;
          default:
            errorMessage += event.error;
        }
        console.error('Error en reconocimiento de voz (Proyecto):', event.error);
        micStatus.textContent = errorMessage;
        micStatus.style.color = "#dc3545";
        resetMicStatus(micStatus);
      };

      recognition.onsoundend = () => {
        if (micStatus.textContent === "Escuchando... Hable ahora") {
          micStatus.textContent = "Tiempo de escucha terminado";
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      };
    } else {
      micProyecto.style.display = 'none';
      micStatus.textContent = "El reconocimiento de voz no está disponible en este navegador";
      micStatus.style.color = "#dc3545";
    }

    proyectoForm.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(proyectoForm);
      const formDataObject = Object.fromEntries(formData);
      console.log('Enviando datos a API (Formulario Proyecto):', formDataObject);

      fetch('guardar_proyecto.php', {
        method: 'POST',
        body: formData
      })
      .then(res => {
        console.log('Respuesta de API (Formulario Proyecto):', {
          status: res.status,
          statusText: res.statusText
        });
        if (!res.ok) {
          throw new Error(`Error HTTP: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        console.log('Datos recibidos de API (Formulario Proyecto):', data);
        if(data.success){
          mensajeProyectoDiv.innerHTML = '<p style="color:green;">Proyecto registrado con éxito.</p>';
          proyectoForm.reset();
          micStatus.textContent = "Presione el micrófono para registrar proyecto por voz";
          micStatus.style.color = "#4366e6";
          announceSuccess("Proyecto guardado con éxito");
        } else {
          mensajeProyectoDiv.innerHTML = '<p style="color:red;">Error al registrar proyecto: ' + data.message + '</p>';
        }
      })
      .catch(error => {
        console.error('Error en API (Formulario Proyecto):', error);
        mensajeProyectoDiv.innerHTML = '<p style="color:red;">Error en conexión con el servidor: ' + error.message + '</p>';
      });
    });
  }

  function loadRegistrarGastos() {
    content.innerHTML = `
      <h2>Registrar Gasto</h2>
      <div id="mic-icon-container" aria-label="Ingresar descripción de gasto por voz" role="button" tabindex="0">
        <svg id="mic-gasto" viewBox="0 0 24 24" fill="#4366e6" stroke="#4366e6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM12 19v3m-4 0h8"/>
        </svg>
        <div id="mic-status" class="mic-status">Presione el micrófono para registrar gasto por voz</div>
      </div>
      <form id="gasto-form" aria-label="Formulario para registrar gasto">
        <label for="descripcion_gasto">Descripción de Gasto</label>
        <textarea id="descripcion_gasto" name="descripcion_gasto" rows="3" required></textarea>
        
        <label for="monto">Monto</label>
        <input type="number" id="monto" name="monto" step="0.01" required />
        
        <label for="fecha_gasto">Fecha del Gasto</label>
        <input type="date" id="fecha_gasto" name="fecha_gasto" required />
        
        <button type="submit" class="btn-primary">Guardar Gasto</button>
      </form>
      <div id="mensaje-gasto"></div>
    `;
    
    const gastoForm = document.getElementById('gasto-form');
    const mensajeGastoDiv = document.getElementById('mensaje-gasto');
    const micGasto = document.getElementById('mic-gasto');
    const micStatus = document.getElementById('mic-status');
    const descripcionGastoInput = document.getElementById('descripcion_gasto');
    const montoInput = document.getElementById('monto');
    const fechaGastoInput = document.getElementById('fecha_gasto');

    const today = new Date().toISOString().split('T')[0];
    fechaGastoInput.value = today;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-PE';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      micGasto.addEventListener('click', () => {
        try {
          micStatus.textContent = "Escuchando... Hable ahora";
          micStatus.style.color = "#4366e6";
          recognition.start();
        } catch (error) {
          console.error('Error al iniciar reconocimiento de voz (Gasto):', error);
          micStatus.textContent = "Error al iniciar el micrófono: " + error.message;
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      });

      recognition.onresult = async (event) => {
        const speechResult = event.results[0][0].transcript;
        micStatus.textContent = "Transcripción recibida: " + speechResult;
        micStatus.style.color = "#28a745";

        try {
          micStatus.textContent = "Procesando gasto...";
          const requestData = {
            texto: speechResult,
            fecha: new Date().toISOString()
          };
          console.log('Enviando datos a API (Gasto por voz):', requestData);

          const response = await fetch('https://www.kingsoft.pe:5678/webhook/gastos', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
          });

          console.log('Respuesta de API (Gasto por voz):', {
            status: response.status,
            statusText: response.statusText
          });

          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          console.log('Datos recibidos de API (Gasto por voz):', data);

          if (data.success) {
            if (data.descripcion) descripcionGastoInput.value = data.descripcion;
            if (data.monto) montoInput.value = data.monto;
            if (data.fecha) fechaGastoInput.value = data.fecha.split('T')[0];

            micStatus.textContent = "Gasto registrado por voz correctamente";
            micStatus.style.color = "#28a745";
            mensajeGastoDiv.innerHTML = '<p style="color:green;">Gasto registrado por voz correctamente. Revise los datos y haga clic en "Guardar Gasto" para confirmar.</p>';
            announceSuccess("Gasto registrado con éxito");
          } else {
            micStatus.textContent = "Error al procesar gasto por voz: " + (data.message || 'Error desconocido');
            micStatus.style.color = "#dc3545";
            resetMicStatus(micStatus);
          }
        } catch (error) {
          console.error('Error en API (Gasto por voz):', error);
          micStatus.textContent = "Error de conexión con el servicio de voz: " + error.message;
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      };

      recognition.onerror = (event) => {
        let errorMessage = "Error en reconocimiento de voz: ";
        switch(event.error) {
          case 'no-speech':
            errorMessage += "No se detectó voz";
            break;
          case 'audio-capture':
            errorMessage += "No se pudo capturar audio";
            break;
          case 'not-allowed':
            errorMessage += "Permiso denegado para usar el micrófono";
            break;
          default:
            errorMessage += event.error;
        }
        console.error('Error en reconocimiento de voz (Gasto):', event.error);
        micStatus.textContent = errorMessage;
        micStatus.style.color = "#dc3545";
        resetMicStatus(micStatus);
      };

      recognition.onsoundend = () => {
        if (micStatus.textContent === "Escuchando... Hable ahora") {
          micStatus.textContent = "Tiempo de escucha terminado";
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      };
    } else {
      micGasto.style.display = 'none';
      micStatus.textContent = "El reconocimiento de voz no está disponible en este navegador";
      micStatus.style.color = "#dc3545";
    }

    gastoForm.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(gastoForm);
      const formDataObject = Object.fromEntries(formData);
      console.log('Enviando datos a API (Formulario Gasto):', formDataObject);

      fetch('guardar_gasto.php', {
        method: 'POST',
        body: formData
      })
      .then(res => {
        console.log('Respuesta de API (Formulario Gasto):', {
          status: res.status,
          statusText: res.statusText
        });
        if (!res.ok) {
          throw new Error(`Error HTTP: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        console.log('Datos recibidos de API (Formulario Gasto):', data);
        if(data.success){
          mensajeGastoDiv.innerHTML = '<p style="color:green;">Gasto registrado con éxito.</p>';
          gastoForm.reset();
          fechaGastoInput.value = today;
          micStatus.textContent = "Presione el micrófono para registrar gasto por voz";
          micStatus.style.color = "#4366e6";
          announceSuccess("Gasto guardado con éxito");
        } else {
          mensajeGastoDiv.innerHTML = '<p style="color:red;">Error al registrar gasto: ' + data.message + '</p>';
        }
      })
      .catch(error => {
        console.error('Error en API (Formulario Gasto):', error);
        mensajeGastoDiv.innerHTML = '<p style="color:red;">Error en conexión con el servidor: ' + error.message + '</p>';
      });
    });
  }

  function loadRegistrarDeudas() {
    content.innerHTML = `
      <h2>Registrar Deuda</h2>
      <div id="mic-icon-container" aria-label="Ingresar por voz" role="description">
        <svg id="mic-deuda" viewBox="0 0 24 24" fill="#4366e6" stroke="#4366e6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM12 19v3m-4 0h8"/>
        </svg>
        <div id="mic-status" class="mic-status">Presione el micrófono para registrar deuda por voz</div>
      </div>
      <form id="deuda-form" aria-label="Formulario para registrar deuda">
        <label for="nombre_deuda">Ingresar Nombres</label>
        <input type="text" id="nombre_deuda" name="nombre_deuda" required />

        <label for="dni_deuda">Ingresar el DNI</label>
        <input type="text" id="dni_deuda" name="dni_deuda" minlength="8" maxlength="8" pattern="\d{8}" required />

        <label for="descripcion_deuda">Descripción de la deuda</label>
        <textarea id="descripcion_deuda" name="descripcion_deuda" rows="3"></textarea>

        <label for="monto_deuda">Monto</label>
        <input type="number" id="monto_deuda" name="monto_deuda" step="0.01" required />

        <label for="estado_deuda">Estado</label>
        <select id="estado_deuda" name="estado_deuda" required>
          <option value="Pendiente">Pendiente</option>
          <option value="Pagado">Pagada</option>
          <option value="Vencida">Vencida</option>
        </select>

        <label for="fecha_deuda">Fecha</label>
        <input type="date" id="fecha_deuda" name="fecha_deuda" required />

        <button type="submit" class="btn-primary">Enviar</button>
      </form>
      <div id="mensaje-deuda"></div>
    `;

    const deudaForm = document.getElementById('deuda-form');
    const mensajeDeudaDiv = document.getElementById('mensaje-deuda');
    const micDeuda = document.getElementById('mic-deuda');
    const micStatus = document.getElementById('mic-status');
    const nombreInput = document.getElementById('nombre_deuda');
    const dniInput = document.getElementById('dni_deuda');
    const descripcionInput = document.getElementById('descripcion_deuda');
    const montoInput = document.getElementById('monto_deuda');
    const estadoInput = document.getElementById('estado_deuda');
    const fechaInput = document.getElementById('fecha_deuda');

    const today = new Date().toISOString().split('T')[0];
    fechaInput.value = today;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-PE';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      micDeuda.addEventListener('click', () => {
        try {
          micStatus.textContent = "Escuchando... Hable ahora";
          micStatus.style.color = "#4366e6";
          recognition.start();
        } catch (error) {
          console.error('Error al iniciar reconocimiento de voz (Deuda):', error);
          micStatus.textContent = "Error al iniciar el micrófono: " + error.message;
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      });

      recognition.onresult = async (event) => {
        const speechResult = event.results[0][0].transcript;
        micStatus.textContent = "Transcripción recibida: " + speechResult;
        micStatus.style.color = "#28a745";

        try {
          micStatus.textContent = "Procesando deuda...";
          const requestData = {
            texto: speechResult,
            fecha: new Date().toISOString()
          };
          console.log('Enviando datos a API (Deuda por voz):', requestData);

          const response = await fetch('https://www.kingsoft.pe:5678/webhook/deuda', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
          });

          console.log('Respuesta de API (Deuda por voz):', {
            status: response.status,
            statusText: response.statusText
          });

          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          console.log('Datos recibidos de API (Deuda por voz):', data);

          if (data.success) {
            if (data.nombre) nombreInput.value = data.nombre;
            if (data.dni) dniInput.value = data.dni;
            if (data.descripcion) descripcionInput.value = data.descripcion;
            if (data.monto) montoInput.value = data.monto;
            if (data.estado) estadoInput.value = data.estado;
            if (data.fecha) fechaInput.value = data.fecha.split('T')[0];

            micStatus.textContent = "Deuda registrada por voz correctamente";
            micStatus.style.color = "#28a745";
            mensajeDeudaDiv.innerHTML = '<p style="color:green;">Deuda registrada por voz correctamente. Revise los datos y haga clic en "Guardar" para confirmar.</p>';
            announceSuccess("Deuda registrada con éxito");
          } else {
            micStatus.textContent = "Error al procesar deuda por voz: " + (data.message || 'Error desconocido');
            micStatus.style.color = "#dc3545";
            resetMicStatus(micStatus);
          }
        } catch (error) {
          console.error('Error en API (Deuda por voz):', error);
          micStatus.textContent = "Error de conexión con el servicio de voz: " + error.message;
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      };

      recognition.onerror = (event) => {
        let errorMessage = "Error en reconocimiento de voz: ";
        switch(event.error) {
          case 'no-speech':
            errorMessage += "No se detectó voz";
            break;
          case 'audio-capture':
            errorMessage += "No se pudo capturar audio";
            break;
          case 'not-allowed':
            errorMessage += "Permiso denegado para usar el micrófono";
            break;
          default:
            errorMessage += event.error;
        }
        console.error('Error en reconocimiento de voz (Deuda):', event.error);
        micStatus.textContent = errorMessage;
        micStatus.style.color = "#dc3545";
        resetMicStatus(micStatus);
      };

      recognition.onsoundend = () => {
        if (micStatus.textContent === "Escuchando... Hable ahora") {
          micStatus.textContent = "Tiempo de escucha terminado";
          micStatus.style.color = "#dc3545";
          resetMicStatus(micStatus);
        }
      };
    } else {
      micDeuda.style.display = 'none';
      micStatus.textContent = "El reconocimiento de voz no está disponible en este navegador";
      micStatus.style.color = "#dc3545";
    }

    deudaForm.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(deudaForm);
      const formDataObject = Object.fromEntries(formData);
      console.log('Enviando datos a API (Formulario Deuda):', formDataObject);

      fetch('guardar_deuda.php', {
        method: 'POST',
        body: formData
      })
      .then(res => {
        console.log('Respuesta de API (Formulario Deuda):', {
          status: res.status,
          statusText: res.statusText
        });
        if (!res.ok) {
          throw new Error(`Error HTTP: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        console.log('Datos recibidos de API (Formulario Deuda):', data);
        if(data.success){
          mensajeDeudaDiv.innerHTML = '<p style="color:green;">Deuda registrada con éxito.</p>';
          deudaForm.reset();
          fechaInput.value = today;
          micStatus.textContent = "Presione el micrófono para registrar deuda por voz";
          micStatus.style.color = "#4366e6";
          announceSuccess("Deuda guardada con éxito");
        } else {
          mensajeDeudaDiv.innerHTML = '<p style="color:red;">Error al registrar deuda: ' + data.message + '</p>';
        }
      })
      .catch(error => {
        console.error('Error en API (Formulario Deuda):', error);
        mensajeDeudaDiv.innerHTML = '<p style="color:red;">Error en conexión con el servidor: ' + error.message + '</p>';
      });
    });
  }
</script>

</body>
</html>
